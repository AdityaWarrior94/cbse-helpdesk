<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PW Gulf Online CBSE Student Helpdesk | Issue Form</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af;
    --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --line:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#0f172acc;backdrop-filter:blur(6px)}
  header h1{margin:0;font-size:18px;letter-spacing:.2px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:960px){ .grid{grid-template-columns:1.1fr .9fr} }
  .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  h2{margin:0 0 10px 0;font-size:18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .stack>*+*{margin-top:10px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text],input[type=number],select,textarea{
    width:100%;padding:10px 12px;border:1px solid #223047;background:#0b1220;color:var(--ink);
    border-radius:8px;font-size:14px;outline:none
  }
  textarea{min-height:120px;resize:vertical}
  input[type=file]{color:var(--muted);font-size:13px}
  button{
    appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--accent);color:#071427;
    font-weight:600;cursor:pointer
  }
  button.secondary{background:#1f2937;color:var(--ink)}
  .help{font-size:12px;color:var(--muted)}
  .split{display:grid;grid-template-columns:1fr;gap:16px}
  .right{max-height:70vh;overflow:auto;border-radius:10px;border:1px solid var(--line)}
  .timeline{background:#0b1328;border:1px solid var(--line);border-radius:10px;padding:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .ok{background:#052e20;color:#86efac;border:1px solid #14532d}
  .warn{background:#3a2a07;color:#fde68a;border:1px solid #a16207}
  .danger{background:#3b0a0a;color:#fecaca;border:1px solid #7f1d1d}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:14px}
  thead th{position:sticky;top:0;background:#0b1426}
  .status{font-weight:600}
  .footer-note{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>PW Gulf Online CBSE Helpdesk â€” Term-1 Doubt & Support</h1>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: FORM -->
    <div class="panel">
      <h2>Submit Your Issue</h2>
      <form id="issueForm" class="stack" enctype="multipart/form-data">
        <div class="row">
          <div>
            <label for="studentName">Student Name (auto Proper Case)</label>
            <input id="studentName" name="studentName" type="text" placeholder="e.g., aditya singh" required />
          </div>
          <div>
            <label for="batchName">Batch Name (auto Proper Case)</label>
            <input id="batchName" name="batchName" type="text" placeholder="e.g., NEET-Alpha" required />
          </div>
        </div>

        <div class="row-3">
          <div>
            <label for="grade">Grade</label>
            <select id="grade" name="grade" required>
              <option value="" disabled selected>Choose Grade</option>
              <option>Class 8</option>
              <option>Class 9</option>
              <option>Class 10</option>
              <option>Class 11</option>
              <option>Class 12</option>
            </select>
          </div>
          <div>
            <label for="section">Section</label>
            <select id="section" name="section" required>
              <option value="" disabled selected>Choose Section</option>
              <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
            </select>
          </div>
          <div>
            <label>Registered Portal Number</label>
            <div class="row" style="grid-template-columns: 0.9fr 1.1fr;">
              <select id="cc" name="countryCode" required>
                <option value="+971">ðŸ‡¦ðŸ‡ª +971 (UAE)</option>
                <option value="+966">ðŸ‡¸ðŸ‡¦ +966 (Saudi)</option>
                <option value="+965">ðŸ‡°ðŸ‡¼ +965 (Kuwait)</option>
                <option value="+974">ðŸ‡¶ðŸ‡¦ +974 (Qatar)</option>
                <option value="+968">ðŸ‡´ðŸ‡² +968 (Oman)</option>
                <option value="+973">ðŸ‡§ðŸ‡­ +973 (Bahrain)</option>
                <option value="+91">ðŸ‡®ðŸ‡³ +91 (India)</option>
              </select>
              <input id="portalNumber" name="portalNumber" type="number" inputmode="numeric" placeholder="e.g., 501234567" required />
            </div>
            <div class="help">Country code + numeric portal number</div>
          </div>
        </div>

        <div>
          <label for="doubtType">Type of Doubt</label>
          <select id="doubtType" name="doubtType" required>
            <option value="" disabled selected>Select Doubt Type</option>
            <option>Tech</option>
            <option>Academic</option>
            <option>Fee Related</option>
            <option>Support Related</option>
            <option>Portal Related</option>
            <option>Teacher Related</option>
            <option>Content Related</option>
            <option>Exam Related</option>
            <option>Syllabus Related</option>
          </select>
        </div>

        <div>
          <label for="explain">Explain in Words</label>
          <textarea id="explain" name="explain" placeholder="Describe your issue clearly..." required></textarea>
        </div>

        <div>
          <label for="image">Upload Image (optional, .jpg/.png)</label>
          <input id="image" name="image" type="file" accept="image/*" />
        </div>

        <div class="row">
          <button type="submit">SUBMIT</button>
          <button type="button" id="resetBtn" class="secondary">Reset</button>
        </div>

        <div id="afterSubmit" class="timeline" style="display:none;"></div>
        <div class="footer-note">All submissions go to Google Sheet: <em>Response</em> (replace endpoint below).</div>
      </form>
    </div>

    <!-- RIGHT: RESPONSE SHEET + RATING -->
    <div class="panel">
      <h2>Issue Status (Public View)</h2>
      <div class="right">
        <table id="statusTable">
          <thead>
            <tr>
              <th style="width:46%">Issue Code</th>
              <th style="width:54%">Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- Filled from Google Sheet CSV (only IssueCode & Status shown) -->
          </tbody>
        </table>
      </div>

      <div class="stack" style="margin-top:16px">
        <h2>Submit Rating (After Resolved)</h2>
        <form id="ratingForm" class="stack">
          <div class="row">
            <div>
              <label for="issueIdRate">Issue Code</label>
              <input id="issueIdRate" name="issueIdRate" type="text" placeholder="e.g., ISS-20250808-123" required />
            </div>
            <div>
              <label for="rating">Rating</label>
              <select id="rating" name="rating" required>
                <option value="" disabled selected>Rate</option>
                <option>1 - Poor</option>
                <option>2 - Fair</option>
                <option>3 - Good</option>
                <option>4 - Very Good</option>
                <option>5 - Excellent</option>
              </select>
            </div>
          </div>
          <div>
            <label for="ratingNote">Optional Note</label>
            <textarea id="ratingNote" name="ratingNote" placeholder="Any feedback..."></textarea>
          </div>
          <div>
            <button type="submit">Submit Rating</button>
          </div>
          <div id="ratingMsg" class="help"></div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG (replace these) ===================== */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx2u3wPx8xJ40SGb7ve4dZzUIeAz1OphAiCNQGlXH3vA_4Bf6wtmn8er1ltfrxEeRh_/exec"; // <-- replace
// Published CSV of your Response sheet (File > Share to web > CSV OR Apps Script return CSV)
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR5QUIu5Rgt60enJRY67cq-DgqaPGIG16GW8i3USMmp4CE9B7PsQ2L8mtzXO6-CqNXOncW7Cq0oJETw/pub?gid=0&single=true&output=csv"; // <-- replace
/* ================================================================= */

/* ---------- Utils ---------- */
function toProperCase(str){
  return (str||"")
    .toLowerCase()
    .replace(/(^|[\\s\\-_/\\.])([a-z])/g, (_,p1,p2)=> p1 + p2.toUpperCase());
}
function genIssueCode(){
  const d=new Date();
  const pad=n=> String(n).padStart(2,'0');
  const code = `ISS-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${d.getHours()}${pad(d.getMinutes())}${pad(d.getSeconds())}-${Math.floor(Math.random()*900+100)}`;
  return code;
}
function readFileAsBase64(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(fr.result);
    fr.onerror=reject;
    fr.readAsDataURL(file);
  });
}

/* ---------- Proper Case on blur ---------- */
const nameEl = document.getElementById('studentName');
const batchEl = document.getElementById('batchName');
[nameEl,batchEl].forEach(el=>{
  el.addEventListener('blur',()=> el.value = toProperCase(el.value));
});

/* ---------- Submit Issue ---------- */
const issueForm = document.getElementById('issueForm');
const afterSubmit = document.getElementById('afterSubmit');
const resetBtn = document.getElementById('resetBtn');

issueForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    // Prepare payload
    const issueCode = genIssueCode();
    const form = new FormData(issueForm);
    // normalize text to proper case again
    form.set('studentName', toProperCase(form.get('studentName')));
    form.set('batchName', toProperCase(form.get('batchName')));

    const phone = (form.get('countryCode')||'') + (form.get('portalNumber')||'');
    form.set('fullPortal', phone);
    form.set('issueCode', issueCode);
    form.set('action', 'create');   // tell Apps Script this is a create
    form.set('sheetName', 'Response'); // your sheet tab name

    // Image to base64 (optional)
    const imgInput = document.getElementById('image');
    if(imgInput.files && imgInput.files[0]){
      const file = imgInput.files[0];
      if(!file.type.startsWith('image/')) throw new Error('Only image files allowed');
      const b64 = await readFileAsBase64(file);
      form.set('imageData', b64); // Apps Script: store to Drive & put link in sheet
      form.set('imageName', file.name);
    }

    // POST to Apps Script Web App
    const res = await fetch(APPS_SCRIPT_URL, { method:'POST', body: form });
    if(!res.ok) throw new Error('Network error');
    const txt = await res.text(); // your script can return JSON/text
    console.log('Server says:', txt);

    // Show timeline (dummy for now)
    const type = form.get('doubtType');
    const t = buildTimeline(type, issueCode);
    afterSubmit.innerHTML = t;
    afterSubmit.style.display = 'block';

    // refresh right side table
    fetchResponses();

    // scroll to timeline
    afterSubmit.scrollIntoView({behavior:'smooth', block:'start'});
  }catch(err){
    console.error(err);
    afterSubmit.innerHTML = `<span class="pill danger">Error:</span> ${err.message}`;
    afterSubmit.style.display = 'block';
  }
});

resetBtn.addEventListener('click', ()=>{
  issueForm.reset();
  afterSubmit.style.display='none';
});

/* ---------- Dummy timeline logic (edit later) ---------- */
function buildTimeline(type, code){
  // You asked: "For now fill random condition in min" â€” demo SLAs below
  const rules = {
    "Tech": {sla:"30 min", steps:["Ticket created","Tech triage","Fix in progress","Resolved"]},
    "Academic": {sla:"4 hrs", steps:["Academic mentor assigned","Doubt review","Solution shared","Closed"]},
    "Fee Related": {sla:"24 hrs", steps:["Finance review","Verification","Resolution update","Closed"]},
    "Support Related": {sla:"2 hrs", steps:["Support queue","Agent picked","Guided steps shared","Resolved"]},
    "Portal Related": {sla:"3 hrs", steps:["Portal team check","Bug/Config","Patch applied","Closed"]},
    "Teacher Related": {sla:"12 hrs", steps:["Escalate to HOD","Teacher response","Plan of action","Closed"]},
    "Content Related": {sla:"8 hrs", steps:["QC check","Corrected material","Re-uploaded","Closed"]},
    "Exam Related": {sla:"6 hrs", steps:["Exam team review","Admit/instructions fix","Notice shared","Closed"]},
    "Syllabus Related": {sla:"12 hrs", steps:["Schedule check","Update plan","Notify student","Closed"]}
  };
  const r = rules[type] || {sla:"6 hrs", steps:["Queued","In Progress","Under Review","Closed"]};
  return `
    <div><span class="pill ok">Submitted</span> <strong>${code}</strong></div>
    <div class="help">Type: <strong>${type}</strong> â€¢ SLA Target: <strong>${r.sla}</strong></div>
    <ol style="margin:8px 0 0 18px;">
      ${r.steps.map(s=>`<li>${s}</li>`).join("")}
    </ol>
  `;
}

/* ---------- Load Response Sheet (IssueCode + Status only) ---------- */
async function fetchResponses(){
  const tbody = document.querySelector('#statusTable tbody');
  tbody.innerHTML = `<tr><td colspan="2">Loading...</td></tr>`;
  try{
    const res = await fetch(SHEET_CSV_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('Sheet not reachable');
    const csv = await res.text();
    const rows = parseCSV(csv);
    // Expect headers: IssueCode, Status, ... (rest ignored)
    const header = rows[0] || [];
    const codeIdx = header.findIndex(h => /issue.?code/i.test(h));
    const statusIdx = header.findIndex(h => /status/i.test(h));
    const body = rows.slice(1);
    tbody.innerHTML = "";
    if(codeIdx === -1 || statusIdx === -1){
      tbody.innerHTML = `<tr><td colspan="2">Couldnâ€™t find IssueCode/Status columns in CSV.</td></tr>`;
      return;
    }
    body.forEach(r=>{
      if(!r.length) return;
      const code = r[codeIdx]||"";
      const status = r[statusIdx]||"";
      const badge = status.toLowerCase().includes('resolved') ? 'ok'
                  : status.toLowerCase().includes('progress') ? 'warn'
                  : 'danger';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(code)}</td><td class="status"><span class="pill ${badge}">${escapeHtml(status)}</span></td>`;
      tbody.appendChild(tr);
    });
    if(!tbody.children.length){
      tbody.innerHTML = `<tr><td colspan="2">No issues yet.</td></tr>`;
    }
  }catch(err){
    console.error(err);
    const tbody = document.querySelector('#statusTable tbody');
    tbody.innerHTML = `<tr><td colspan="2">Failed to load sheet. Replace SHEET_CSV_URL.</td></tr>`;
  }
}
function parseCSV(str){
  // simple CSV parser for basic cases (no embedded newlines)
  const lines = str.trim().split(/\r?\n/);
  return lines.map(l=>{
    // naive split, handles quoted commas minimally
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<l.length;i++){
      const ch=l[i];
      if(ch==='\"'){ q=!q; continue; }
      if(ch===',' && !q){ out.push(cur); cur=''; continue; }
      cur+=ch;
    }
    out.push(cur);
    return out.map(s=>s.trim());
  });
}
function escapeHtml(s){ return (s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

/* ---------- Rating Submit ---------- */
const ratingForm = document.getElementById('ratingForm');
const ratingMsg = document.getElementById('ratingMsg');

ratingForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  ratingMsg.textContent = "Submitting...";
  try{
    const fd = new FormData(ratingForm);
    fd.set('action','feedback');
    fd.set('sheetName','Feedback'); // Feedback subsheet
    const res = await fetch(APPS_SCRIPT_URL, {method:'POST', body: fd});
    if(!res.ok) throw new Error("Network error");
    const txt = await res.text();
    console.log('Feedback server says:', txt);
    ratingMsg.textContent = "Thanks! Feedback recorded.";
    ratingForm.reset();
  }catch(err){
    console.error(err);
    ratingMsg.textContent = "Error: " + err.message;
  }
});

/* ---------- Init ---------- */
fetchResponses();
</script>
</body>
</html>
